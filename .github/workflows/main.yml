name: Deploy to Render

on:
  push:
    branches:
      - main  # Change to your target branch if needed

permissions:
  deployments: write  # Grant write access to deployments

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Create GitHub Deployment
      - name: Create GitHub Deployment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log("Creating deployment...");
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.ref,
                task: 'deploy',
                environment: 'production',
                description: 'Deploying to Render',
                required_contexts: [],
                auto_merge: false
              });
              console.log("Deployment created successfully:", deployment);
              core.setOutput('deployment_id', deployment.data.id);
            } catch (error) {
              console.error("Error creating deployment:", error);
              core.setFailed(error.message); 
            }

      # Step 3: Trigger Render Deploy Hook
      - name: Trigger Render Deploy Hook
        run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

      # Step 4: Update GitHub Deployment Status
      - name: Update GitHub Deployment Status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const deploymentId = context.workflow.jobs.Create_GitHub_Deployment.outputs.deployment_id; 
            console.log("Deployment ID:", deploymentId); 
            if (deploymentId) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deploymentId, 
                state: 'success',
                environment: 'production',
                environment_url: 'https://nodewikipedia.onrender.com',
                description: 'Render deployment successful!'
              });
            } else {
              console.error("Deployment ID is not set. Skipping status update.");
            }
